//
//  AdminView.swift
//  Family Cinema Pro
//
//  Tela de configura√ß√µes administrativas
//

import SwiftUI

struct AdminView: View {
    // MARK: - Properties
    @ObservedObject var configService: ConfigService
    @Environment(\.dismiss) private var dismiss
    
    // MARK: - State Variables
    @State private var showingAuthSheet = true
    @State private var isAuthenticated = false
    @State private var username = ""
    @State private var password = ""
    @State private var isTestingConnection = false
    @State private var testResult: String?
    @State private var showingAlert = false
    @State private var alertMessage = ""
    
    // MARK: - Admin Credentials
    private let adminUsername = "admin"
    private let adminPassword = "admin"
    
    var body: some View {
        ZStack {
            // Background
            Color.backgroundDark
                .ignoresSafeArea()
            
            // Conte√∫do principal (SEM VStack que cria espa√ßo)
            Group {
                if isAuthenticated {
                    adminConfigView
                } else {
                    authenticationView
                }
            }
            
            // Bot√£o fechar sobreposto (posi√ß√£o absoluta)
            VStack {
                HStack {
                    Spacer()
                    Button(action: { dismiss() }) {
                        ZStack {
                            Circle()
                                .fill(Color.black.opacity(0.6))
                                .frame(width: 36, height: 36)
                            
                            Image(systemName: "xmark")
                                .font(.system(size: 16, weight: .semibold))
                                .foregroundColor(.white)
                        }
                    }
                    .padding(.horizontal, 20)
                    .padding(.top, 60)
                }
                Spacer() // Manter bot√£o no topo
            }
        }
        .alert("Resultado", isPresented: $showingAlert) {
            Button("OK") { }
        } message: {
            Text(alertMessage)
        }
    }
    
    // MARK: - Authentication View (MUITO SUBIDA)
    private var authenticationView: some View {
        ScrollView {
            VStack(spacing: 8) { // Spacing m√≠nimo
                // Spacer pequeno para bot√£o fechar
                Spacer().frame(height: 35) // REDUZIDO de 120 para 80
                
                // Logo e t√≠tulo (compactos)
                VStack(spacing: 6) { // REDUZIDO de 8 para 6
                    Text("ACESSO ADMINISTRATIVO")
                        .font(.title3) // REDUZIDO de .title2
                        .fontWeight(.bold)
                        .foregroundColor(.primaryColor)
                    
                    Text("√Årea restrita para administradores")
                        .font(.caption) // REDUZIDO de .subheadline
                        .foregroundColor(.textSecondary)
                }
                
                // Formul√°rio de login (compacto)
                VStack(spacing: 12) { // REDUZIDO de 16 para 12
                    VStack(alignment: .leading, spacing: 6) { // REDUZIDO de 8 para 6
                        Text("CREDENCIAIS DE ACESSO")
                            .font(.caption2) // REDUZIDO
                            .fontWeight(.bold)
                            .foregroundColor(.primaryColor)
                        
                        TextField("Usu√°rio Administrador", text: $username)
                            .textFieldStyle(CustomTextFieldStyle())
                        
                        SecureField("Senha de Administrador", text: $password)
                            .textFieldStyle(CustomTextFieldStyle())
                    }
                    
                    Button(action: authenticateUser) {
                        Text("ACESSAR ADMINISTRA√á√ÉO")
                            .frame(maxWidth: .infinity)
                    }
                    .buttonStyle(PrimaryButtonStyle())
                }
                .padding(18) // REDUZIDO de 24 para 18
                .modifier(CardBackground())
                .padding(.horizontal)
                
                Spacer() // Espa√ßo restante
            }
        }
        .background(Color.backgroundDark)
    }
    
    // MARK: - Admin Configuration View (OTIMIZADA)
    private var adminConfigView: some View {
        ScrollView {
            VStack(spacing: 16) { // Espa√ßamento reduzido
                // Spacer m√≠nimo para o bot√£o fechar
                Spacer().frame(height: 35) // REDUZIDO de 100 para 80
                
                // T√≠tulo (compacto)
                HStack {
                    Text("CONFIGURA√á√ïES PRINCIPAIS")
                        .font(.headline) // REDUZIDO de .title3
                        .fontWeight(.bold)
                        .foregroundColor(.primaryColor)
                    Spacer()
                }
                .padding(.horizontal)
                
                // Configura√ß√µes obrigat√≥rias
                requiredConfigSection
                
                // Configura√ß√µes avan√ßadas
                advancedConfigSection
                
                // Exemplo de configura√ß√£o
                exampleConfigSection
                
                // Spacer final m√≠nimo
                Spacer().frame(height: 20)
            }
        }
        .background(Color.backgroundDark)
    }
    
    // MARK: - Required Config Section (SUPER COMPACTA)
    private var requiredConfigSection: some View {
        VStack(alignment: .leading, spacing: 8) { // REDUZIDO de 12 para 8
            Text("Campos Obrigat√≥rios *")
                .font(.subheadline) // REDUZIDO de .headline
                .fontWeight(.bold)
                .foregroundColor(.white)
            
            VStack(spacing: 8) { // REDUZIDO de 10 para 8
                VStack(alignment: .leading, spacing: 2) {
                    Text("Host/DNS *")
                        .font(.caption) // REDUZIDO de .subheadline
                        .foregroundColor(.textSecondary)
                    TextField("Ex: seuservidor.com.br", text: $configService.config.hostDns)
                        .textFieldStyle(CustomTextFieldStyle())
                }
                
                VStack(alignment: .leading, spacing: 2) {
                    Text("Usu√°rio *")
                        .font(.caption)
                        .foregroundColor(.textSecondary)
                    TextField("Ex: 929431775851", text: $configService.config.username)
                        .textFieldStyle(CustomTextFieldStyle())
                }
                
                VStack(alignment: .leading, spacing: 2) {
                    Text("Senha *")
                        .font(.caption)
                        .foregroundColor(.textSecondary)
                    SecureField("Ex: 028531357846", text: $configService.config.password)
                        .textFieldStyle(CustomTextFieldStyle())
                }
                
                HStack(spacing: 6) { // REDUZIDO de 8 para 6
                    Button(action: testConnection) {
                        HStack {
                            if isTestingConnection {
                                ProgressView()
                                    .progressViewStyle(CircularProgressViewStyle(tint: .white))
                                    .scaleEffect(0.8)
                            } else {
                                Text("üîç")
                            }
                            Text("Testar")
                        }
                        .frame(maxWidth: .infinity)
                    }
                    .buttonStyle(SecondaryButtonStyle())
                    .disabled(isTestingConnection)
                    
                    Button(action: saveConfiguration) {
                        Text("üíæ Salvar")
                            .frame(maxWidth: .infinity)
                    }
                    .buttonStyle(PrimaryButtonStyle())
                }
                
                // Resultado do teste
                if let testResult = testResult {
                    Text(testResult)
                        .font(.caption2) // REDUZIDO
                        .foregroundColor(testResult.contains("‚úÖ") ? .successColor : .errorColor)
                        .padding(.top, 2)
                }
            }
        }
        .padding(12) // REDUZIDO de 16 para 12
        .modifier(CardBackground())
        .padding(.horizontal)
    }
    
    // MARK: - Advanced Config Section (SUPER COMPACTA)
    private var advancedConfigSection: some View {
        VStack(alignment: .leading, spacing: 8) { // REDUZIDO de 12 para 8
            HStack {
                Text("üîß")
                    .font(.headline) // REDUZIDO
                Text("CONFIGURA√á√ïES AVAN√áADAS")
                    .font(.subheadline) // REDUZIDO
                    .fontWeight(.bold)
                    .foregroundColor(.accentBlue)
            }
            
            VStack(spacing: 8) { // REDUZIDO de 10 para 8
                // Formato da playlist
                VStack(alignment: .leading, spacing: 4) { // REDUZIDO de 6 para 4
                    Text("Formato da Playlist:")
                        .font(.caption) // REDUZIDO
                        .foregroundColor(.white)
                    
                    HStack {
                        Button(action: { configService.config.playlistFormat = "ts" }) {
                            HStack {
                                Image(systemName: configService.config.playlistFormat == "ts" ? "checkmark.circle.fill" : "circle")
                                    .foregroundColor(.primaryColor)
                                Text("TS")
                                    .foregroundColor(.white)
                                    .font(.caption)
                            }
                        }
                        
                        Spacer()
                        
                        Button(action: { configService.config.playlistFormat = "hls" }) {
                            HStack {
                                Image(systemName: configService.config.playlistFormat == "hls" ? "checkmark.circle.fill" : "circle")
                                    .foregroundColor(.primaryColor)
                                Text("HLS")
                                    .foregroundColor(.white)
                                    .font(.caption)
                            }
                        }
                    }
                }
                
                VStack(alignment: .leading, spacing: 2) {
                    Text("DNS Alternativo")
                        .font(.caption)
                        .foregroundColor(.textSecondary)
                    TextField("Ex: servidor2.com.br", text: $configService.config.alternativeDns)
                        .textFieldStyle(CustomTextFieldStyle())
                }
                
                VStack(alignment: .leading, spacing: 2) {
                    Text("Porta")
                        .font(.caption)
                        .foregroundColor(.textSecondary)
                    TextField("Padr√£o: 80", text: $configService.config.port)
                        .textFieldStyle(CustomTextFieldStyle())
                        .keyboardType(.numberPad)
                }
                
                VStack(alignment: .leading, spacing: 2) {
                    Text("Intervalo (min)")
                        .font(.caption)
                        .foregroundColor(.textSecondary)
                    TextField("30", text: $configService.config.updateInterval)
                        .textFieldStyle(CustomTextFieldStyle())
                        .keyboardType(.numberPad)
                }
                
                VStack(alignment: .leading, spacing: 4) {
                    Toggle("Reconex√£o Autom√°tica", isOn: $configService.config.autoReconnect)
                        .foregroundColor(.white)
                        .font(.caption)
                    
                    Toggle("Acelera√ß√£o por Hardware", isOn: $configService.config.hardwareAcceleration)
                        .foregroundColor(.white)
                        .font(.caption)
                }
                
                HStack(spacing: 6) {
                    Button(action: exportConfiguration) {
                        Text("üì§")
                            .frame(maxWidth: .infinity)
                    }
                    .buttonStyle(SecondaryButtonStyle())
                    
                    Button(action: clearCache) {
                        Text("üóëÔ∏è")
                            .frame(maxWidth: .infinity)
                    }
                    .buttonStyle(SecondaryButtonStyle())
                    
                    Button(action: logout) {
                        Text("üö™")
                            .frame(maxWidth: .infinity)
                    }
                    .buttonStyle(SecondaryButtonStyle())
                }
            }
        }
        .padding(12) // REDUZIDO de 16 para 12
        .modifier(CardBackground())
        .padding(.horizontal)
    }
    
    // MARK: - Example Config Section (COMPACTA)
    private var exampleConfigSection: some View {
        VStack(alignment: .leading, spacing: 6) { // REDUZIDO de 12 para 6
            HStack {
                Text("üí°")
                    .font(.headline)
                Text("EXEMPLO")
                    .font(.subheadline) // REDUZIDO
                    .fontWeight(.bold)
                    .foregroundColor(.successColor)
            }
            
            VStack(alignment: .leading, spacing: 4) { // REDUZIDO de 6 para 4
                Text("Dados de Exemplo:")
                    .font(.caption) // REDUZIDO
                    .fontWeight(.bold)
                    .foregroundColor(.successColor)
                
                Text("""
                Host: seuservidor.com.br
                User: 123456 | Pass: 123456
                """)
                    .font(.system(.caption2, design: .monospaced)) // REDUZIDO
                    .foregroundColor(.white)
                    .padding(8) // REDUZIDO de 12 para 8
                    .background(Color.backgroundDark)
                    .cornerRadius(6)
                
                Text("URL: \(generateExampleURL())")
                    .font(.system(.caption2, design: .monospaced))
                    .foregroundColor(.white)
                    .padding(6) // REDUZIDO de 8 para 6
                    .background(Color.black.opacity(0.3))
                    .cornerRadius(6)
                    .lineLimit(2)
            }
        }
        .padding(12) // REDUZIDO de 16 para 12
        .background(Color.successColor.opacity(0.1))
        .cornerRadius(12)
        .padding(.horizontal)
    }
    
    // MARK: - Methods
    private func authenticateUser() {
        if username == adminUsername && password == adminPassword {
            withAnimation {
                isAuthenticated = true
            }
        } else {
            alertMessage = "‚ùå Credenciais inv√°lidas\nTente: admin / admin"
            showingAlert = true
            password = ""
        }
    }
    
    private func testConnection() {
        isTestingConnection = true
        testResult = nil
        
        Task {
            let success = await configService.testConnection()
            
            DispatchQueue.main.async {
                self.isTestingConnection = false
                
                if success {
                    self.testResult = "‚úÖ Conex√£o bem-sucedida!"
                } else {
                    self.testResult = "‚ùå Falha na conex√£o: \(configService.lastError ?? "Erro desconhecido")"
                }
            }
        }
    }
    
    private func saveConfiguration() {
        // Gerar URL da playlist
        configService.generatePlaylistURL()
        
        // Salvar configura√ß√£o
        configService.saveConfiguration()
        
        alertMessage = "‚úÖ Configura√ß√£o salva com sucesso!\nA lista de canais ser√° atualizada."
        showingAlert = true
        
        // Fechar tela de admin ap√≥s salvar
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
            dismiss()
        }
    }
    
    private func exportConfiguration() {
        let config = """
        Configura√ß√£o Epic Cinema Pro
        ===========================
        Host/DNS: \(configService.config.hostDns)
        Usu√°rio: \(configService.config.username)
        Formato: \(configService.config.playlistFormat)
        Porta: \(configService.config.port)
        URL Playlist: \(configService.config.playlistUrl)
        Data: \(DateFormatter.localizedString(from: Date(), dateStyle: .short, timeStyle: .short))
        """
        
        UIPasteboard.general.string = config
        
        alertMessage = "üíæ Configura√ß√µes exportadas!\nüìã Dados copiados para o clipboard"
        showingAlert = true
    }
    
    private func clearCache() {
        // Limpar cache (implementa√ß√£o b√°sica)
        URLCache.shared.removeAllCachedResponses()
        
        alertMessage = "üóëÔ∏è Cache limpo com sucesso!\nüì± Espa√ßo liberado"
        showingAlert = true
    }
    
    private func logout() {
        withAnimation {
            isAuthenticated = false
            username = ""
            password = ""
        }
    }
    
    private func generateExampleURL() -> String {
        if configService.config.hostDns.isEmpty {
            return "http://servidor.com/get.php?user=user&pass=pass&type=m3u_plus"
        } else {
            configService.generatePlaylistURL()
            return configService.config.playlistUrl
        }
    }
}

struct AdminView_Previews: PreviewProvider {
    static var previews: some View {
        AdminView(configService: ConfigService())
    }
}
